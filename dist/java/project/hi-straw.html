<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>稻草人图床神器小程序后台 | 七七九九六</title>
    <meta name="description" content="个人网站">
    <link rel="icon" href="/logo.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.aca50b0a.css" as="style"><link rel="preload" href="/assets/js/app.0cee35f0.js" as="script"><link rel="preload" href="/assets/js/2.78f23174.js" as="script"><link rel="preload" href="/assets/js/8.5ddf5166.js" as="script"><link rel="prefetch" href="/assets/js/10.fc139a1b.js"><link rel="prefetch" href="/assets/js/11.0c24bb64.js"><link rel="prefetch" href="/assets/js/12.a67458e0.js"><link rel="prefetch" href="/assets/js/13.9c237e8d.js"><link rel="prefetch" href="/assets/js/14.b582099b.js"><link rel="prefetch" href="/assets/js/15.729c2ffd.js"><link rel="prefetch" href="/assets/js/16.c8ac7939.js"><link rel="prefetch" href="/assets/js/17.dbf42153.js"><link rel="prefetch" href="/assets/js/18.c80dbf25.js"><link rel="prefetch" href="/assets/js/19.26f8708c.js"><link rel="prefetch" href="/assets/js/20.278bee0a.js"><link rel="prefetch" href="/assets/js/21.05adcccb.js"><link rel="prefetch" href="/assets/js/22.dca709f8.js"><link rel="prefetch" href="/assets/js/23.af8b2a3e.js"><link rel="prefetch" href="/assets/js/24.ae69e687.js"><link rel="prefetch" href="/assets/js/25.6e9c4eab.js"><link rel="prefetch" href="/assets/js/26.6b382647.js"><link rel="prefetch" href="/assets/js/27.2f508fa3.js"><link rel="prefetch" href="/assets/js/28.52a2c94b.js"><link rel="prefetch" href="/assets/js/3.f08f183e.js"><link rel="prefetch" href="/assets/js/4.1b2928d7.js"><link rel="prefetch" href="/assets/js/5.a80eb1ab.js"><link rel="prefetch" href="/assets/js/6.168d2d4d.js"><link rel="prefetch" href="/assets/js/7.755fd1f5.js"><link rel="prefetch" href="/assets/js/9.bfe5ed02.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aca50b0a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">七七九九六</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/project/" class="nav-link router-link-active">项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/server/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/server/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/server/mysql/" class="nav-link">Mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/miniapp/" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/web/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/w77996" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/project/" class="nav-link router-link-active">项目</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/server/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/server/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/server/mysql/" class="nav-link">Mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/miniapp/" class="nav-link">小程序</a></li><li class="dropdown-item"><!----> <a href="/web/vue/" class="nav-link">Vue</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/w77996" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/project/hi-straw.html" class="active sidebar-link">稻草人图床神器小程序后台</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#前期准备" class="sidebar-link">前期准备</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#七牛云文件上传" class="sidebar-link">七牛云文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-七牛云账号申请" class="sidebar-link">1.七牛云账号申请</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-七牛云sdk引入" class="sidebar-link">2.七牛云SDK引入</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-七牛云token生成" class="sidebar-link">2. 七牛云token生成</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_3-上传文件代码编写" class="sidebar-link">3.上传文件代码编写</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_4-删除图片" class="sidebar-link">4.删除图片</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#注解-aop接口限流" class="sidebar-link">注解+AOP接口限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-注解编写" class="sidebar-link">1. 注解编写</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-aop实现" class="sidebar-link">2.AOP实现</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_3-注解使用" class="sidebar-link">3. 注解使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#jwt实现" class="sidebar-link">JWT实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-jwt生成" class="sidebar-link">1.jwt生成</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-token解析成userid" class="sidebar-link">2.token解析成userId</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_3-拦截器-注解方式进行token鉴权" class="sidebar-link">3.拦截器+注解方式进行token鉴权</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_4-实现web拦截器" class="sidebar-link">4.实现web拦截器</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#druid监控配置" class="sidebar-link">Druid监控配置</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#全局异常拦截" class="sidebar-link">全局异常拦截</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#微信登录" class="sidebar-link">微信登录</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#spring-boot-maven多环境打包" class="sidebar-link">spring boot + maven多环境打包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-resouce下的yml文件" class="sidebar-link">1.resouce下的yml文件</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-pom-xml配置" class="sidebar-link">2.pom.xml配置</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_3-不同环境打包" class="sidebar-link">3.不同环境打包</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_4-项目打包命名" class="sidebar-link">4.项目打包命名</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#shell脚本编写" class="sidebar-link">shell脚本编写</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#maven-docker-打包部署" class="sidebar-link">maven + docker 打包部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-docker环境安装" class="sidebar-link">1.docker环境安装</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-项目编译打包" class="sidebar-link">2.项目编译打包</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#nginx配置https" class="sidebar-link">nginx配置https</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_1-安装nginx" class="sidebar-link">1.安装nginx</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_2-获取证书" class="sidebar-link">2. 获取证书</a></li><li class="sidebar-sub-header"><a href="/java/project/hi-straw.html#_3-配置nginx文件" class="sidebar-link">3. 配置nginx文件</a></li></ul></li></ul></li><li><a href="/java/project/yunzhijia.html" class="sidebar-link">Python实现云之家自动签到</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="稻草人图床神器小程序后台"><a href="#稻草人图床神器小程序后台" aria-hidden="true" class="header-anchor">#</a> 稻草人图床神器小程序后台</h1> <p>hi-straw</p> <h1 id="项目结构"><a href="#项目结构" aria-hidden="true" class="header-anchor">#</a> 项目结构</h1> <div class="language- line-numbers-mode"><pre class="language-text"><code>hi-straw
├── common -- 公共模块
├── config -- 配置模块
├── controller -- controller接口
├── core -- 核心业务模块
|    ├── annontaion -- 注解
|    ├── aop -- aop实现
|    ├── constant -- 常量
|    ├── filter -- 拦截器
|    ├── jwt -- jwt相关
|    └── result -- 结果返回
├── entity -- 实体类
|    ├── dto -- 数据传输
|    └── vo -- 页面传输
├── exception -- 全局异常
├── mapper -- dao层
├── service -- service层
└── util -- 工具类

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h1 id="数据库设计"><a href="#数据库设计" aria-hidden="true" class="header-anchor">#</a> 数据库设计</h1> <div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE `t_straw_file` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` int(11) UNSIGNED DEFAULT NULL COMMENT '用户ID',
  `file_path` varchar(255) DEFAULT NULL COMMENT '文件路径',
  `file_name` varchar(100) DEFAULT NULL COMMENT '文件名',
  `file_size` varchar(10) DEFAULT NULL COMMENT '文件大小',
  `props` varchar(255) DEFAULT NULL,
  `status` tinyint(5) UNSIGNED DEFAULT '0' COMMENT '0.正常 -1.删除',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT'创建时间',
  PRIMARY KEY (`id`),
    KEY `user_id` (`user_id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8mb4 COMMENT '用户文件列表';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE `t_straw_user` (
  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_name` varchar(20) DEFAULT NULL COMMENT '用户名',
  `nickname` varchar(20) DEFAULT NULL COMMENT '用户昵称',
  `user_logo` varchar(250) DEFAULT NULL COMMENT '用户logo',
  `phone_num` varchar(20) DEFAULT NULL COMMENT '手机号',
  `open_id` varchar(55) DEFAULT NULL COMMENT '微信openId',
  `union_id` varchar(20) DEFAULT NULL COMMENT '微信union_id',
  `password` varchar(50) DEFAULT NULL COMMENT '密码',
  `uuid` varchar(20) DEFAULT NULL COMMENT '自定义生成的uuid',
  `last_login` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '最后登陆时间',
	`create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
	UNIQUE KEY `open_id` (`open_id`) USING HASH
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COMMENT '用户表';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE `t_straw_user_file_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) UNSIGNED NOT NULL COMMENT '用户ID',
  `file_size` int(11) UNSIGNED DEFAULT '0' COMMENT '用户文件大小',
  `left_size` int(11) UNSIGNED DEFAULT '5242880' COMMENT '剩余文件大小',
  `total_size` int(11)UNSIGNED DEFAULT '5242880' COMMENT '用户文件空间大小',
  `file_num` int(11) UNSIGNED DEFAULT '0' COMMENT '文件数量',
  `is_vip` tinyint(5) UNSIGNED DEFAULT '0' COMMENT '是否为vip,1.是 0.否',
  PRIMARY KEY (`id`),
  UNIQUE KEY `user_id` (`user_id`) USING HASH
) ENGINE=InnoDB AUTO_INCREMENT=43 DEFAULT CHARSET=utf8mb4 COMMENT'用户文件信息';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>CREATE TABLE `t_straw_user_info` (
  `user_id` int(11)  UNSIGNED NOT NULL COMMENT '用户ID',
  `sex` tinyint(5) UNSIGNED DEFAULT NULL COMMENT '性别',
  `location` varchar(55) DEFAULT NULL COMMENT '位置',
  `platform` varchar(55) DEFAULT NULL COMMENT '平台',
  `birthday` datetime DEFAULT NULL COMMENT '生日',
  PRIMARY KEY (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '用户详细表';
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h1 id="代码详解"><a href="#代码详解" aria-hidden="true" class="header-anchor">#</a> 代码详解</h1> <h2 id="前期准备"><a href="#前期准备" aria-hidden="true" class="header-anchor">#</a> 前期准备</h2> <ul><li>linux服务器及MySql数据库</li> <li>七牛云账号，可以去<a href="https://note.youdao.com/" target="_blank" rel="noopener noreferrer">七牛云官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>申请账号</li> <li>HTTPS证书 <a href="https://www.aliyun.com/product/cas?spm=5176.224200.1280361.173.78256ed67r0qWd" target="_blank" rel="noopener noreferrer">阿里云获取免费证书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>微信公众平台小程序开发者账号</li></ul> <h2 id="七牛云文件上传"><a href="#七牛云文件上传" aria-hidden="true" class="header-anchor">#</a> 七牛云文件上传</h2> <p>代码<code>com.w77996.straw.util.QiNiuUtil</code></p> <h3 id="_1-七牛云账号申请"><a href="#_1-七牛云账号申请" aria-hidden="true" class="header-anchor">#</a> 1.七牛云账号申请</h3> <p><a href="https://note.youdao.com/" target="_blank" rel="noopener noreferrer">七牛云官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>申请账号，获得<code>AccessKey</code>,<code>SecretKey</code>,并设置七牛云图片<code>bucket</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    /**
     * 七牛accessKey
     */
    @Value(&quot;${QiNiu.accessKey}&quot;)
    private String accessKey;
    /**
     * 七牛密钥
     */
    @Value(&quot;${QiNiu.secretKey}&quot;)
    private String secretKey;
    /**
     * 七牛bucket
     */
    @Value(&quot;${QiNiu.bucket}&quot;)
    private String bucket;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-七牛云sdk引入"><a href="#_2-七牛云sdk引入" aria-hidden="true" class="header-anchor">#</a> 2.七牛云SDK引入</h3> <p><code>pom.xml</code>文件引入七牛云仓库</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    &lt;dependency&gt;
        &lt;groupId&gt;com.qiniu&lt;/groupId&gt;
        &lt;artifactId&gt;qiniu-java-sdk&lt;/artifactId&gt;
        &lt;version&gt;[7.2.0, 7.2.99]&lt;/version&gt;
    &lt;/dependency&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_2-七牛云token生成"><a href="#_2-七牛云token生成" aria-hidden="true" class="header-anchor">#</a> 2. 七牛云token生成</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>    /**
     * 七牛云生成token
     *
     * @param fileName
     * @return
     */
    public QiNiuAuth generateToken(String userId, String fileName) {
        Auth auth = Auth.create(accessKey, secretKey);
        String key = &quot;upload/file/000/&quot; + userId + &quot;/&quot; + fileName;
        StringMap putPolicy = new StringMap();
        putPolicy.put(&quot;returnBody&quot;, &quot;{\&quot;key\&quot;:\&quot;$(key)\&quot;,\&quot;hash\&quot;:\&quot;$(etag)\&quot;,\&quot;bucket\&quot;:\&quot;$(bucket)\&quot;,\&quot;fsize\&quot;:$(fsize)}&quot;);
        long expireSeconds = 3600;
        String upToken = auth.uploadToken(bucket, key, expireSeconds, putPolicy);
        Map&lt;String, String&gt; resultMap = Maps.newHashMapWithExpectedSize(3);
        resultMap.put(&quot;domain&quot;, &quot;https://www.w77996.cn&quot;);
        resultMap.put(&quot;key&quot;, key);
        resultMap.put(&quot;upToken&quot;, upToken);
        return new QiNiuAuth(&quot;https://www.w77996.cn&quot;, key, upToken);
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_3-上传文件代码编写"><a href="#_3-上传文件代码编写" aria-hidden="true" class="header-anchor">#</a> 3.上传文件代码编写</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>    /**
     * 上传图片
     *
     * @param file
     * @param key
     * @param token
     * @return
     */
    public String uploadImage(MultipartFile file, String key, String token) {
        Configuration cfg = new Configuration(Zone.zone2());
        UploadManager uploadManager = new UploadManager(cfg);
        String filePath = null;
        //生成上传凭证，不指定key的情况下，以文件内容的hash值作为文件名
        Response response = null;
        try {
            byte[] uploadBytes = file.getBytes();
            Auth auth = Auth.create(accessKey, secretKey);
            String upToken = auth.uploadToken(bucket);
            try {
                response = uploadManager.put(uploadBytes, key, upToken);
                //解析上传成功的结果
                DefaultPutRet putRet = new Gson().fromJson(response.bodyString(), DefaultPutRet.class);
                log.info(&quot;上传结果 {} {}&quot;, putRet.hash, putRet.key);
                filePath = putRet.key;
            } catch (QiniuException ex) {
                try {
                    response = ex.response;
                    log.error(response.bodyString());
                } catch (QiniuException ex2) {
                    //ignore
                    ex.printStackTrace();
                }
            }
        } catch (Exception ex) {
            //ignore
            ex.printStackTrace();
        }
        return filePath;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="_4-删除图片"><a href="#_4-删除图片" aria-hidden="true" class="header-anchor">#</a> 4.删除图片</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>    /**
     * 删除图片
     *
     * @param key
     */
    public void delete(String key) {
        Configuration cfg = new Configuration(Zone.zone2());
        Auth auth = Auth.create(accessKey, secretKey);
        //实例化一个BucketManager对象
        BucketManager bucketManager = new BucketManager(auth, cfg);
        try {
            //调用delete方法移动文件
            bucketManager.delete(bucket, key);
        } catch (QiniuException e) {
            //捕获异常信息
            throw new GlobalException(ResultCode.ERROR);
        }
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="注解-aop接口限流"><a href="#注解-aop接口限流" aria-hidden="true" class="header-anchor">#</a> 注解+AOP接口限流</h2> <h3 id="_1-注解编写"><a href="#_1-注解编写" aria-hidden="true" class="header-anchor">#</a> 1. 注解编写</h3> <p>代码<code>com.w77996.straw.core.annotation.Limiter</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface Limiter {

    /**
     *
     * @return
     */
    String value() default &quot;&quot;;

    /**
     * 每秒向桶中放入令牌的数量   默认最大即不做限流
     * @return
     */
    double perSecond() default Double.MAX_VALUE;

    /**
     * 获取令牌的等待时间  默认0
     * @return
     */
    int timeOut() default 0;

    /**
     * 超时时间单位
     * @return
     */
    TimeUnit timeOutUnit() default TimeUnit.MILLISECONDS;
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_2-aop实现"><a href="#_2-aop实现" aria-hidden="true" class="header-anchor">#</a> 2.AOP实现</h3> <p>代码<code>com.w77996.straw.core.aop.RateLimitAspect</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Aspect
@Component
@Slf4j
public class RateLimitAspect {

    private RateLimiter rateLimiter = RateLimiter.create(Double.MAX_VALUE);

    /**
     * 定义切点
     * 1、通过扫包切入
     * 2、带有指定注解切入
     */
    @Pointcut(&quot;@annotation(com.w77996.straw.core.annotation.Limiter)&quot;)
    public void checkPointcut() {
    }

    @ResponseBody
    @Around(value = &quot;checkPointcut()&quot;)
    public Object aroundNotice(ProceedingJoinPoint pjp) throws Throwable {
        log.info(&quot;拦截到了{}方法...&quot;, pjp.getSignature().getName());
        Signature signature = pjp.getSignature();
        MethodSignature methodSignature = (MethodSignature) signature;
        //获取目标方法
        Method targetMethod = methodSignature.getMethod();
        if (targetMethod.isAnnotationPresent(Limiter.class)) {
            //获取目标方法的@Limiter注解
            Limiter limiter = targetMethod.getAnnotation(Limiter.class);
            rateLimiter.setRate(limiter.perSecond());
            if (!rateLimiter.tryAcquire(limiter.timeOut(), limiter.timeOutUnit())) {
                log.info(&quot;rateLimiter lock&quot;);
                return Result.error(ResultCode.BUSY);
            }
        }
        return pjp.proceed();
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_3-注解使用"><a href="#_3-注解使用" aria-hidden="true" class="header-anchor">#</a> 3. 注解使用</h3> <p>限定每秒只能调用一次，如果超出，则返回<code>Result.error(ResultCode.BUSY)</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    @GetMapping(&quot;/limit&quot;)
    @Limiter(perSecond = 1.0, timeOut = 500)
    public String testLimiter() {
        return &quot; success&quot;;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="jwt实现"><a href="#jwt实现" aria-hidden="true" class="header-anchor">#</a> JWT实现</h2> <h3 id="_1-jwt生成"><a href="#_1-jwt生成" aria-hidden="true" class="header-anchor">#</a> 1.jwt生成</h3> <p>使用JwtUtil生成jwt Token</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>     /**
     * 生成jwt
     *
     * @param userId
     * @return
     */
    public static String createJWT(String userId) {
        String token = JwtHelper.createJWT(userId, Constant.JWT_CLIENT_ID,
                Constant.JWT_NAME, Constant.JWT_EXPIRES_SECOND, Constant.JWT_BASE64_SECRET);
        return token;
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-token解析成userid"><a href="#_2-token解析成userid" aria-hidden="true" class="header-anchor">#</a> 2.token解析成userId</h3> <p>将userId放入token中，在请求接口时可以通过请求Header获取Bearer ${token}，然后对${token}进行解码，从而获取userId。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    /**
     * 通过token获取用户信息
     *
     * @return
     */
    public String getUserIdByToken() {
        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        String accessToken = request.getHeader(&quot;Authorization&quot;);
        if (StringUtils.isEmpty(accessToken) || accessToken.length() &lt; 20) {
            throw new GlobalException(ResultCode.ERROR_TOKEN_NULL);
        }
        accessToken = accessToken.substring(7);
        if (&quot;admin&quot;.equals(accessToken)) {
            return &quot;1&quot;;
        }
        Claims claims = JwtHelper.parseJWT(accessToken, Constant.JWT_BASE64_SECRET);
        return claims.getSubject();
    }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_3-拦截器-注解方式进行token鉴权"><a href="#_3-拦截器-注解方式进行token鉴权" aria-hidden="true" class="header-anchor">#</a> 3.拦截器+注解方式进行token鉴权</h3> <p>代码 <code>com.w77996.straw.core.annotation.IgnoreToken</code><br>
先设置忽略token的注解</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * @description: 忽略token
 * @author: w77996
 **/
@Retention(RetentionPolicy.RUNTIME)
@Target(value={ElementType.METHOD,ElementType.TYPE})
public @interface IgnoreToken {
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>代码 <code>com.w77996.straw.core.filter.TokenFilter</code><br>
拦截器<code>TokenFilter</code>实现<code>HandlerInterceptor</code>，在每次请求进来时进行拦截,在调用controller之前都会调用<code>perHandle</code>,所以在<code>perHandler</code>内获取方法名的注解，判断是否有ignoreToken的注解，然后进行jwt的校验。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        IgnoreToken ignoreToken = handlerMethod.getBeanType().getAnnotation(IgnoreToken.class);
        log.info(&quot;enter preHandle {}&quot;,request.getRequestURL());
        if (ignoreToken == null) {
            ignoreToken = handlerMethod.getMethodAnnotation(IgnoreToken.class);
        }
        if (ignoreToken != null) {
            log.info(&quot;ignoreToken not null&quot;);
            return true;
        }
        log.info(&quot;ignoreToken  null&quot;);
        String token = request.getHeader(&quot;Authorization&quot;);
        if(token != null){
            log.info(&quot;token is {}&quot;,token);
            if (&quot;admin&quot;.equals(token.substring(7))) {
                return true;
            }
            Claims claims = JwtHelper.parseJWT(token.substring(7), Audience.BASE64SECRET);
            if(claims != null){
                log.info(&quot;claims is {} {}&quot;,claims.toString(),claims.getSubject());
                return true;
            }else{
                log.info(&quot;claims is null&quot;);
                throw new GlobalException(ResultCode.ERROR_AUTH);
            }
        }
        return false;
    }

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_4-实现web拦截器"><a href="#_4-实现web拦截器" aria-hidden="true" class="header-anchor">#</a> 4.实现web拦截器</h3> <p>代码<code>com.w77996.straw.config.WebMvcAdapterConfig</code>
不拦截<code>/druid/*</code>的接口</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/**
 * @description: web拦截器
 * @author: w77996
 **/
@Component
public class WebMvcAdapterConfig extends WebMvcConfigurationSupport {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new TokenFilter()).excludePathPatterns(&quot;/druid/*&quot;);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="druid监控配置"><a href="#druid监控配置" aria-hidden="true" class="header-anchor">#</a> Druid监控配置</h2> <p>代码<code>com.w77996.straw.config.DruidConfig</code><br>
项目运行后访问<code>http://ip:port/druid</code>,输入账号<code>admin</code>密码<code>amdin</code>即可访问</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
public class DruidConfig {

    @Bean
    @ConfigurationProperties(&quot;spring.datasource&quot;)
    public DataSource druidDataSource() {
        DruidDataSource dataSource = new DruidDataSource();
        return dataSource;
    }

    @Bean
    public ServletRegistrationBean druidStatViewServlet() {
        ServletRegistrationBean registrationBean = new ServletRegistrationBean(new StatViewServlet(), &quot;/druid/*&quot;);
        // IP白名单 (没有配置或者为空，则允许所有访问)e
        registrationBean.addInitParameter(&quot;allow&quot;, &quot;&quot;);
        // IP黑名单 (存在共同时，deny优先于allow)
        registrationBean.addInitParameter(&quot;deny&quot;, &quot;&quot;);
        registrationBean.addInitParameter(&quot;loginUsername&quot;, &quot;admin&quot;);
        registrationBean.addInitParameter(&quot;loginPassword&quot;, &quot;admin&quot;);
        registrationBean.addInitParameter(&quot;resetEnable&quot;, &quot;false&quot;);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean druidWebStatViewFilter() {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(new WebStatFilter());
        registrationBean.addInitParameter(&quot;urlPatterns&quot;, &quot;/*&quot;);
        registrationBean.addInitParameter(&quot;exclusions&quot;, &quot;*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*&quot;);
        return registrationBean;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="全局异常拦截"><a href="#全局异常拦截" aria-hidden="true" class="header-anchor">#</a> 全局异常拦截</h2> <p>全局异常拦截主要是依靠<code>@RestControllerAdvice</code>注解，在方法上使用<code>@ExceptionHandler(value = Exception.class)</code>代表拦截所有Exception,然后进行对应的操作</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * 全局错误拦截
     *
     * @param e
     * @return
     */
    @ExceptionHandler(value = Exception.class)
    private Result&lt;Object&gt; exceptionHandler(Exception e) {
        if (e instanceof GlobalException) {
            GlobalException ex = (GlobalException) e;
            return Result.error(ex.getCode());
        }
        return Result.error(ResultCode.ERROR.getCode(),e.getMessage());
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="微信登录"><a href="#微信登录" aria-hidden="true" class="header-anchor">#</a> 微信登录</h2> <p>需要在微信公共平台获取对应的appId,appSec，小程序获取到code之后发送给后台，后台获取code向微信发送http请求，使用的是restTemplate,但是需要注意编码，微信编码返回是ISO-8859-1；调用成功后可以拿到用户的openId,再去数据库中获取对应的用户信息，进行登陆更新及用户创建的逻辑处理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@RestController
@RequestMapping(&quot;/wx&quot;)
@Slf4j
public class WxController {

    @Autowired
    private IUserService iUserService;

    @Value(&quot;${wx.appId}&quot;)
    private String wxAppId;

    @Value(&quot;${wx.appSec}&quot;)
    private String wxAppSec;

    /**
     * 通过code获取openId
     *
     * @param wxLoginDto
     * @return
     */
    @IgnoreToken
    @PostMapping(&quot;/code&quot;)
    public Result getUserInfoByCode(@RequestBody WxLoginDto wxLoginDto) {
        log.info(&quot;enter getUserInfoByCode&quot;);
        //微信授权获取openId
        String reqUrl = &quot;https://api.weixin.qq.com/sns/jscode2session?appid=&quot; + wxAppId + &quot;&amp;secret=&quot; + wxAppSec + &quot;&amp;js_code=&quot; + wxLoginDto.getCode() + &quot;&amp;grant_type=authorization_code&quot;;
        JSONObject wxAuthObject = RestHttpClient.client(reqUrl, HttpMethod.GET, null);
        log.info(&quot;wxAuthObject {}&quot;, wxAuthObject.toJSONString());
        WxTokenDto wxTokenDto = JSONObject.parseObject(wxAuthObject.toJSONString(), WxTokenDto.class);
        log.info(&quot;wxTokenDto {}&quot;, wxTokenDto.toString());
        Map&lt;String, Object&gt; tokenMapper = Maps.newHashMapWithExpectedSize(2);
        //生成新用户
        UserEntity userEntity = iUserService.getUserByOpenId(wxTokenDto.getOpenid());
        if (!ObjectUtils.allNotNull(userEntity)) {
            WxUserInfoDto wxUserInfoDto = new WxUserInfoDto();
            wxUserInfoDto.setNickname(wxLoginDto.getNickName());
            wxUserInfoDto.setUserLogo(wxLoginDto.getUserLogo());
            wxUserInfoDto.setSex(wxLoginDto.getSex());
            wxUserInfoDto.setLastLogin(new Date());
            wxUserInfoDto.setOpenId(wxTokenDto.getOpenid());
            wxUserInfoDto.setLocation(StringUtils.join(new String[]{wxLoginDto.getCountry(), wxLoginDto.getProvince(), wxLoginDto.getCity()}, &quot;-&quot;));
            iUserService.createNewUser(wxUserInfoDto);
            log.info(&quot;create new user {}&quot;, wxUserInfoDto);
        }
        tokenMapper.put(&quot;token&quot;, JwtHelper.createJWT(userEntity.getId() + &quot;&quot;));
        return Result.success(tokenMapper);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="spring-boot-maven多环境打包"><a href="#spring-boot-maven多环境打包" aria-hidden="true" class="header-anchor">#</a> spring boot + maven多环境打包</h2> <h3 id="_1-resouce下的yml文件"><a href="#_1-resouce下的yml文件" aria-hidden="true" class="header-anchor">#</a> 1.resouce下的yml文件</h3> <p>项目环境分为<code>dev</code>和<code>prod</code>两种，<code>resource</code>文件下默认加载<code>application.yml</code>。</p> <ul><li>dev环境：application-dev.yml</li> <li>prod环境：application-prod.yml
在<code>application.yml</code>中</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>spring:
    profiles:
      active: @spring.profiles.active@
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>@spring.profiles.active@</code>对应的为pom.xml文件中profiles下的<code>spring.profiles.active</code>属性</p> <h3 id="_2-pom-xml配置"><a href="#_2-pom-xml配置" aria-hidden="true" class="header-anchor">#</a> 2.pom.xml配置</h3> <p>默认情况下使用<code>dev</code>环境下的配置信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    &lt;profiles&gt;
        &lt;profile&gt;
            &lt;id&gt;dev&lt;/id&gt;
            &lt;activation&gt;
                &lt;activeByDefault&gt;true&lt;/activeByDefault&gt;
            &lt;/activation&gt;
            &lt;properties&gt;
                &lt;!-- default Spring profiles --&gt;
                &lt;spring.profiles.active&gt;dev&lt;/spring.profiles.active&gt;
            &lt;/properties&gt;
        &lt;/profile&gt;
        &lt;profile&gt;
            &lt;id&gt;prod&lt;/id&gt;
            &lt;properties&gt;
                &lt;!-- default Spring profiles --&gt;
                &lt;spring.profiles.active&gt;prod&lt;/spring.profiles.active&gt;
            &lt;/properties&gt;
        &lt;/profile&gt;
    &lt;/profiles&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_3-不同环境打包"><a href="#_3-不同环境打包" aria-hidden="true" class="header-anchor">#</a> 3.不同环境打包</h3> <ul><li>打包<code>prod</code>环境：执行<code>mvn package -Pprod -DskipTests</code></li> <li>打包<code>dev</code>环境：执行<code>mvn package -Pdev -DskipTests</code></li></ul> <h3 id="_4-项目打包命名"><a href="#_4-项目打包命名" aria-hidden="true" class="header-anchor">#</a> 4.项目打包命名</h3> <p>在<code>properties</code>属性中添加时间格式，然后再<code>build</code>中添加<code>fileName</code>格式化文件名。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    &lt;artifactId&gt;hi-straw&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
    &lt;properties&gt;
        ...
        &lt;maven.build.timestamp.format&gt;yyyy-MM-ddHHmm&lt;/maven.build.timestamp.format&gt;
    &lt;/properties&gt;
    &lt;build&gt;
        ...
        &lt;finalName&gt;
            ${project.artifactId}-${project.version}-${spring.profiles.active}_${maven.build.timestamp}
        &lt;/finalName&gt;
    &lt;/build&gt;

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>打包完成后生成的jar：<code>hi-straw-1.0.0-prod_2019-04-091533.jar</code></p> <h2 id="shell脚本编写"><a href="#shell脚本编写" aria-hidden="true" class="header-anchor">#</a> shell脚本编写</h2> <p>登陆服务器，clone项目至<code>/root/repo_git/</code>目录下,执行进入<code>script</code>目录下，执行<code>./build.sh</code>，需要将<code>RELEASE_HOST</code>换成你自己的服务器地址，方便做保存备份</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#!/bin/sh
set -e
#打包的服务器地址
RELEASE_HOST=&quot;你自己的服务器地址&quot;
#打包的环境
RELEASE_ENV=prod
#项目目录
BASE_DIR=/root/repo_git/Histraw
#进入项目目录
cd ${BASE_DIR}
#执行git拉去最新的代码
echo &quot;pulling changes...&quot;
git pull origin master
echo &quot;pulling changes... finish&quot;
echo &quot;building...&quot;
#执行mvn命令打包
mvn clean
mvn package -P${RELEASE_ENV} -DskipTests docker:build
echo &quot;building...finish&quot;
echo &quot;env =${RELEASE_ENV}&quot;
#for HOST in ${RELEASE_HOST}; do
#进行拷贝及备份
RELEASE_TARGET=root@${RELEASE_HOST}:~/release/
echo &quot;copying to $RELEASE_TARGET...&quot;
scp ${BASE_DIR}/target/*.jar ${RELEASE_TARGET}
echo &quot;copying to $RELEASE_TARGET...done&quot;
#done
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><img src="https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSz6uFHLz8ibYV6icFGjER0eOuaM3jo5mYlG8prMgnhT7LHGRy1NIK2AzZA/0?wx_fmt=png" alt="执行build.sh">
执行<code>docker images</code>查看刚刚打包好的docker镜像
<img src="https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSzvuwuH3u1VAiaeFjicibNjTkNrHiatSsqQZ7YLErBVHvzd8icyae68XyxZEg/0?wx_fmt=png" alt="docker镜像"></p> <h2 id="maven-docker-打包部署"><a href="#maven-docker-打包部署" aria-hidden="true" class="header-anchor">#</a> maven + docker 打包部署</h2> <h3 id="_1-docker环境安装"><a href="#_1-docker环境安装" aria-hidden="true" class="header-anchor">#</a> 1.docker环境安装</h3> <p>卸载老旧的版本（若未安装过可省略此步）：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>sudo apt-get remove docker docker-engine docker.io
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装最新的docker：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>curl -fsSL get.docker.com -o get-docker.sh
sudo sh get-docker.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>确认Docker成功安装：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>docker run hello-world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-项目编译打包"><a href="#_2-项目编译打包" aria-hidden="true" class="header-anchor">#</a> 2.项目编译打包</h3> <p>在<code>src/main/docker</code>下建立<code>dockerFile</code>文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>FROM openjdk:8-jdk-alpine
VOLUME /tmp
ADD *.jar app.jar
ENTRYPOINT [&quot;java&quot;,&quot;-Djava.security.egd=file:/dev/./urandom&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>pom.xml配置docker打包，配合shell脚本在linux实现maven自动打包docker</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> &lt;!-- Docker maven plugin --&gt;
    &lt;plugin&gt;
        &lt;groupId&gt;com.spotify&lt;/groupId&gt;
        &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.0.0&lt;/version&gt;
        &lt;configuration&gt;
            &lt;imageName&gt;${project.artifactId}&lt;/imageName&gt;
            &lt;dockerDirectory&gt;src/main/docker&lt;/dockerDirectory&gt;
            &lt;resources&gt;
                &lt;resource&gt;
                    &lt;targetPath&gt;/&lt;/targetPath&gt;
                    &lt;directory&gt;${project.build.directory}&lt;/directory&gt;
                    &lt;include&gt;${project.build.finalName}.jar&lt;/include&gt;
                &lt;/resource&gt;
            &lt;/resources&gt;
        &lt;/configuration&gt;
    &lt;/plugin&gt;
&lt;!-- Docker maven plugin --&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>执行<code>docker images</code>查看刚刚打包的docker镜像</p> <p>执行<code>docker run --name hi-straw -p 8989:8989 -t hi-straw</code>启动镜像</p> <p>执行<code>dockers ps</code>查看已启动docker镜像
<img src="https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSzTpUZUSb5749UHFTp8ibA7PqyTy7be26Zpl4bth6tiaDyLklkOLWpiazmg/0?wx_fmt=png" alt="已启动"></p> <h2 id="nginx配置https"><a href="#nginx配置https" aria-hidden="true" class="header-anchor">#</a> nginx配置https</h2> <h3 id="_1-安装nginx"><a href="#_1-安装nginx" aria-hidden="true" class="header-anchor">#</a> 1.安装nginx</h3> <p>登陆到服务器，执行</p> <pre><code>$ apt-get update // 更新软件
$ apt-get install nginx // 安装nginx
</code></pre> <h3 id="_2-获取证书"><a href="#_2-获取证书" aria-hidden="true" class="header-anchor">#</a> 2. 获取证书</h3> <p>可以去<a href="https://www.aliyun.com/product/cas?spm=5176.224200.1280361.173.78256ed67r0qWd" target="_blank" rel="noopener noreferrer">阿里云获取免费证书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
将生成的证书放入<code>/etc/nginx/sites-enabled/cert/</code>(具体看你将nginx安装在哪个目录下)</p> <h3 id="_3-配置nginx文件"><a href="#_3-配置nginx文件" aria-hidden="true" class="header-anchor">#</a> 3. 配置nginx文件</h3> <p>新建一个https.conf</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>server {
    listen 443;
    server_name 你自己的域名;
    ssl on;
    ssl_certificate  cert/你自己的证书.pem;
    ssl_certificate_key cert/你自己的证书.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    location / {
        #项目部署的ip和端口
    	proxy_pass http://localhost:port;

    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>配置完成后，检查一下nginx配置文件是否可用</p> <pre><code>nginx -t //检查nginx配置文件
</code></pre> <p>配置正确后，重新加载配置文件使配置生效</p> <pre><code>nginx -s reload //使配置生效
</code></pre> <p>如需重启nginx，用以下命令：</p> <pre><code>service nginx stop //停止
service nginx start //启动
service nginx restart //重启
</code></pre> <h1 id="部署"><a href="#部署" aria-hidden="true" class="header-anchor">#</a> 部署</h1> <p>修改<code>resource</code>下的<code>application-dev.yml</code>和<code>application-prod.yml</code>中你自己申请的微信息及七牛云信息修改，修改数据库地址，用户名和密码</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#七牛
qiNiu:
  accessKey: 你申请的七牛云key
  secretKey: 你申请的七牛云sec
  bucket: 你申请的七牛云bucket
  domain: 你申请的七牛云domain
#微信
wx:
  appId: 你申请的微信id
  appSec: 你申请的微信sec
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>spring:
  datasource:
    name: graduate
    driver-class-name: com.mysql.jdbc.Driver
    url: 数据库地址
    username: 数据库用户名
    password: 数据库密码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>修改<code>script</code>目录下<code>build.sh</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>RELEASE_HOST=&quot;你自己的服务器地址&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/11/2019, 5:29:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/java/project/yunzhijia.html">
          Python实现云之家自动签到
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0cee35f0.js" defer></script><script src="/assets/js/2.78f23174.js" defer></script><script src="/assets/js/8.5ddf5166.js" defer></script>
  </body>
</html>
