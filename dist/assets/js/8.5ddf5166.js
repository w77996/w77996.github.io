(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{187:function(s,n,e){"use strict";e.r(n);var a=e(0),t=Object(a.a)({},function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"稻草人图床神器小程序后台"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#稻草人图床神器小程序后台","aria-hidden":"true"}},[s._v("#")]),s._v(" 稻草人图床神器小程序后台")]),s._v(" "),e("p",[s._v("hi-straw")]),s._v(" "),e("h1",{attrs:{id:"项目结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#项目结构","aria-hidden":"true"}},[s._v("#")]),s._v(" 项目结构")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("hi-straw\n├── common -- 公共模块\n├── config -- 配置模块\n├── controller -- controller接口\n├── core -- 核心业务模块\n|    ├── annontaion -- 注解\n|    ├── aop -- aop实现\n|    ├── constant -- 常量\n|    ├── filter -- 拦截器\n|    ├── jwt -- jwt相关\n|    └── result -- 结果返回\n├── entity -- 实体类\n|    ├── dto -- 数据传输\n|    └── vo -- 页面传输\n├── exception -- 全局异常\n├── mapper -- dao层\n├── service -- service层\n└── util -- 工具类\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h1",{attrs:{id:"数据库设计"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据库设计","aria-hidden":"true"}},[s._v("#")]),s._v(" 数据库设计")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CREATE TABLE `t_straw_file` (\n  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,\n  `user_id` int(11) UNSIGNED DEFAULT NULL COMMENT '用户ID',\n  `file_path` varchar(255) DEFAULT NULL COMMENT '文件路径',\n  `file_name` varchar(100) DEFAULT NULL COMMENT '文件名',\n  `file_size` varchar(10) DEFAULT NULL COMMENT '文件大小',\n  `props` varchar(255) DEFAULT NULL,\n  `status` tinyint(5) UNSIGNED DEFAULT '0' COMMENT '0.正常 -1.删除',\n  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT'创建时间',\n  PRIMARY KEY (`id`),\n    KEY `user_id` (`user_id`) USING BTREE\n) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=utf8mb4 COMMENT '用户文件列表';\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CREATE TABLE `t_straw_user` (\n  `id` int(11) UNSIGNED NOT NULL AUTO_INCREMENT,\n  `user_name` varchar(20) DEFAULT NULL COMMENT '用户名',\n  `nickname` varchar(20) DEFAULT NULL COMMENT '用户昵称',\n  `user_logo` varchar(250) DEFAULT NULL COMMENT '用户logo',\n  `phone_num` varchar(20) DEFAULT NULL COMMENT '手机号',\n  `open_id` varchar(55) DEFAULT NULL COMMENT '微信openId',\n  `union_id` varchar(20) DEFAULT NULL COMMENT '微信union_id',\n  `password` varchar(50) DEFAULT NULL COMMENT '密码',\n  `uuid` varchar(20) DEFAULT NULL COMMENT '自定义生成的uuid',\n  `last_login` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '最后登陆时间',\n\t`create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',\n  PRIMARY KEY (`id`),\n\tUNIQUE KEY `open_id` (`open_id`) USING HASH\n) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=utf8mb4 COMMENT '用户表';\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CREATE TABLE `t_straw_user_file_info` (\n  `id` int(11) NOT NULL AUTO_INCREMENT,\n  `user_id` int(11) UNSIGNED NOT NULL COMMENT '用户ID',\n  `file_size` int(11) UNSIGNED DEFAULT '0' COMMENT '用户文件大小',\n  `left_size` int(11) UNSIGNED DEFAULT '5242880' COMMENT '剩余文件大小',\n  `total_size` int(11)UNSIGNED DEFAULT '5242880' COMMENT '用户文件空间大小',\n  `file_num` int(11) UNSIGNED DEFAULT '0' COMMENT '文件数量',\n  `is_vip` tinyint(5) UNSIGNED DEFAULT '0' COMMENT '是否为vip,1.是 0.否',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `user_id` (`user_id`) USING HASH\n) ENGINE=InnoDB AUTO_INCREMENT=43 DEFAULT CHARSET=utf8mb4 COMMENT'用户文件信息';\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("CREATE TABLE `t_straw_user_info` (\n  `user_id` int(11)  UNSIGNED NOT NULL COMMENT '用户ID',\n  `sex` tinyint(5) UNSIGNED DEFAULT NULL COMMENT '性别',\n  `location` varchar(55) DEFAULT NULL COMMENT '位置',\n  `platform` varchar(55) DEFAULT NULL COMMENT '平台',\n  `birthday` datetime DEFAULT NULL COMMENT '生日',\n  PRIMARY KEY (`user_id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '用户详细表';\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h1",{attrs:{id:"代码详解"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代码详解","aria-hidden":"true"}},[s._v("#")]),s._v(" 代码详解")]),s._v(" "),e("h2",{attrs:{id:"前期准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前期准备","aria-hidden":"true"}},[s._v("#")]),s._v(" 前期准备")]),s._v(" "),e("ul",[e("li",[s._v("linux服务器及MySql数据库")]),s._v(" "),e("li",[s._v("七牛云账号，可以去"),e("a",{attrs:{href:"https://note.youdao.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("七牛云官网"),e("OutboundLink")],1),s._v("申请账号")]),s._v(" "),e("li",[s._v("HTTPS证书 "),e("a",{attrs:{href:"https://www.aliyun.com/product/cas?spm=5176.224200.1280361.173.78256ed67r0qWd",target:"_blank",rel:"noopener noreferrer"}},[s._v("阿里云获取免费证书"),e("OutboundLink")],1)]),s._v(" "),e("li",[s._v("微信公众平台小程序开发者账号")])]),s._v(" "),e("h2",{attrs:{id:"七牛云文件上传"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七牛云文件上传","aria-hidden":"true"}},[s._v("#")]),s._v(" 七牛云文件上传")]),s._v(" "),e("p",[s._v("代码"),e("code",[s._v("com.w77996.straw.util.QiNiuUtil")])]),s._v(" "),e("h3",{attrs:{id:"_1-七牛云账号申请"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-七牛云账号申请","aria-hidden":"true"}},[s._v("#")]),s._v(" 1.七牛云账号申请")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://note.youdao.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("七牛云官网"),e("OutboundLink")],1),s._v("申请账号，获得"),e("code",[s._v("AccessKey")]),s._v(","),e("code",[s._v("SecretKey")]),s._v(",并设置七牛云图片"),e("code",[s._v("bucket")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    /**\n     * 七牛accessKey\n     */\n    @Value("${QiNiu.accessKey}")\n    private String accessKey;\n    /**\n     * 七牛密钥\n     */\n    @Value("${QiNiu.secretKey}")\n    private String secretKey;\n    /**\n     * 七牛bucket\n     */\n    @Value("${QiNiu.bucket}")\n    private String bucket;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"_2-七牛云sdk引入"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-七牛云sdk引入","aria-hidden":"true"}},[s._v("#")]),s._v(" 2.七牛云SDK引入")]),s._v(" "),e("p",[e("code",[s._v("pom.xml")]),s._v("文件引入七牛云仓库")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    <dependency>\n        <groupId>com.qiniu</groupId>\n        <artifactId>qiniu-java-sdk</artifactId>\n        <version>[7.2.0, 7.2.99]</version>\n    </dependency>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"_2-七牛云token生成"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-七牛云token生成","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. 七牛云token生成")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    /**\n     * 七牛云生成token\n     *\n     * @param fileName\n     * @return\n     */\n    public QiNiuAuth generateToken(String userId, String fileName) {\n        Auth auth = Auth.create(accessKey, secretKey);\n        String key = "upload/file/000/" + userId + "/" + fileName;\n        StringMap putPolicy = new StringMap();\n        putPolicy.put("returnBody", "{\\"key\\":\\"$(key)\\",\\"hash\\":\\"$(etag)\\",\\"bucket\\":\\"$(bucket)\\",\\"fsize\\":$(fsize)}");\n        long expireSeconds = 3600;\n        String upToken = auth.uploadToken(bucket, key, expireSeconds, putPolicy);\n        Map<String, String> resultMap = Maps.newHashMapWithExpectedSize(3);\n        resultMap.put("domain", "https://www.w77996.cn");\n        resultMap.put("key", key);\n        resultMap.put("upToken", upToken);\n        return new QiNiuAuth("https://www.w77996.cn", key, upToken);\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"_3-上传文件代码编写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-上传文件代码编写","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.上传文件代码编写")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    /**\n     * 上传图片\n     *\n     * @param file\n     * @param key\n     * @param token\n     * @return\n     */\n    public String uploadImage(MultipartFile file, String key, String token) {\n        Configuration cfg = new Configuration(Zone.zone2());\n        UploadManager uploadManager = new UploadManager(cfg);\n        String filePath = null;\n        //生成上传凭证，不指定key的情况下，以文件内容的hash值作为文件名\n        Response response = null;\n        try {\n            byte[] uploadBytes = file.getBytes();\n            Auth auth = Auth.create(accessKey, secretKey);\n            String upToken = auth.uploadToken(bucket);\n            try {\n                response = uploadManager.put(uploadBytes, key, upToken);\n                //解析上传成功的结果\n                DefaultPutRet putRet = new Gson().fromJson(response.bodyString(), DefaultPutRet.class);\n                log.info("上传结果 {} {}", putRet.hash, putRet.key);\n                filePath = putRet.key;\n            } catch (QiniuException ex) {\n                try {\n                    response = ex.response;\n                    log.error(response.bodyString());\n                } catch (QiniuException ex2) {\n                    //ignore\n                    ex.printStackTrace();\n                }\n            }\n        } catch (Exception ex) {\n            //ignore\n            ex.printStackTrace();\n        }\n        return filePath;\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br")])]),e("h3",{attrs:{id:"_4-删除图片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-删除图片","aria-hidden":"true"}},[s._v("#")]),s._v(" 4.删除图片")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    /**\n     * 删除图片\n     *\n     * @param key\n     */\n    public void delete(String key) {\n        Configuration cfg = new Configuration(Zone.zone2());\n        Auth auth = Auth.create(accessKey, secretKey);\n        //实例化一个BucketManager对象\n        BucketManager bucketManager = new BucketManager(auth, cfg);\n        try {\n            //调用delete方法移动文件\n            bucketManager.delete(bucket, key);\n        } catch (QiniuException e) {\n            //捕获异常信息\n            throw new GlobalException(ResultCode.ERROR);\n        }\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h2",{attrs:{id:"注解-aop接口限流"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#注解-aop接口限流","aria-hidden":"true"}},[s._v("#")]),s._v(" 注解+AOP接口限流")]),s._v(" "),e("h3",{attrs:{id:"_1-注解编写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-注解编写","aria-hidden":"true"}},[s._v("#")]),s._v(" 1. 注解编写")]),s._v(" "),e("p",[s._v("代码"),e("code",[s._v("com.w77996.straw.core.annotation.Limiter")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Target(ElementType.METHOD)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface Limiter {\n\n    /**\n     *\n     * @return\n     */\n    String value() default "";\n\n    /**\n     * 每秒向桶中放入令牌的数量   默认最大即不做限流\n     * @return\n     */\n    double perSecond() default Double.MAX_VALUE;\n\n    /**\n     * 获取令牌的等待时间  默认0\n     * @return\n     */\n    int timeOut() default 0;\n\n    /**\n     * 超时时间单位\n     * @return\n     */\n    TimeUnit timeOutUnit() default TimeUnit.MILLISECONDS;\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br")])]),e("h3",{attrs:{id:"_2-aop实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-aop实现","aria-hidden":"true"}},[s._v("#")]),s._v(" 2.AOP实现")]),s._v(" "),e("p",[s._v("代码"),e("code",[s._v("com.w77996.straw.core.aop.RateLimitAspect")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Aspect\n@Component\n@Slf4j\npublic class RateLimitAspect {\n\n    private RateLimiter rateLimiter = RateLimiter.create(Double.MAX_VALUE);\n\n    /**\n     * 定义切点\n     * 1、通过扫包切入\n     * 2、带有指定注解切入\n     */\n    @Pointcut("@annotation(com.w77996.straw.core.annotation.Limiter)")\n    public void checkPointcut() {\n    }\n\n    @ResponseBody\n    @Around(value = "checkPointcut()")\n    public Object aroundNotice(ProceedingJoinPoint pjp) throws Throwable {\n        log.info("拦截到了{}方法...", pjp.getSignature().getName());\n        Signature signature = pjp.getSignature();\n        MethodSignature methodSignature = (MethodSignature) signature;\n        //获取目标方法\n        Method targetMethod = methodSignature.getMethod();\n        if (targetMethod.isAnnotationPresent(Limiter.class)) {\n            //获取目标方法的@Limiter注解\n            Limiter limiter = targetMethod.getAnnotation(Limiter.class);\n            rateLimiter.setRate(limiter.perSecond());\n            if (!rateLimiter.tryAcquire(limiter.timeOut(), limiter.timeOutUnit())) {\n                log.info("rateLimiter lock");\n                return Result.error(ResultCode.BUSY);\n            }\n        }\n        return pjp.proceed();\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br")])]),e("h3",{attrs:{id:"_3-注解使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-注解使用","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. 注解使用")]),s._v(" "),e("p",[s._v("限定每秒只能调用一次，如果超出，则返回"),e("code",[s._v("Result.error(ResultCode.BUSY)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    @GetMapping("/limit")\n    @Limiter(perSecond = 1.0, timeOut = 500)\n    public String testLimiter() {\n        return " success";\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h2",{attrs:{id:"jwt实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jwt实现","aria-hidden":"true"}},[s._v("#")]),s._v(" JWT实现")]),s._v(" "),e("h3",{attrs:{id:"_1-jwt生成"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-jwt生成","aria-hidden":"true"}},[s._v("#")]),s._v(" 1.jwt生成")]),s._v(" "),e("p",[s._v("使用JwtUtil生成jwt Token")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("     /**\n     * 生成jwt\n     *\n     * @param userId\n     * @return\n     */\n    public static String createJWT(String userId) {\n        String token = JwtHelper.createJWT(userId, Constant.JWT_CLIENT_ID,\n                Constant.JWT_NAME, Constant.JWT_EXPIRES_SECOND, Constant.JWT_BASE64_SECRET);\n        return token;\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"_2-token解析成userid"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-token解析成userid","aria-hidden":"true"}},[s._v("#")]),s._v(" 2.token解析成userId")]),s._v(" "),e("p",[s._v("将userId放入token中，在请求接口时可以通过请求Header获取Bearer ${token}，然后对${token}进行解码，从而获取userId。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    /**\n     * 通过token获取用户信息\n     *\n     * @return\n     */\n    public String getUserIdByToken() {\n        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();\n        String accessToken = request.getHeader("Authorization");\n        if (StringUtils.isEmpty(accessToken) || accessToken.length() < 20) {\n            throw new GlobalException(ResultCode.ERROR_TOKEN_NULL);\n        }\n        accessToken = accessToken.substring(7);\n        if ("admin".equals(accessToken)) {\n            return "1";\n        }\n        Claims claims = JwtHelper.parseJWT(accessToken, Constant.JWT_BASE64_SECRET);\n        return claims.getSubject();\n    }\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h3",{attrs:{id:"_3-拦截器-注解方式进行token鉴权"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-拦截器-注解方式进行token鉴权","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.拦截器+注解方式进行token鉴权")]),s._v(" "),e("p",[s._v("代码 "),e("code",[s._v("com.w77996.straw.core.annotation.IgnoreToken")]),e("br"),s._v("\n先设置忽略token的注解")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/**\n * @description: 忽略token\n * @author: w77996\n **/\n@Retention(RetentionPolicy.RUNTIME)\n@Target(value={ElementType.METHOD,ElementType.TYPE})\npublic @interface IgnoreToken {\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("代码 "),e("code",[s._v("com.w77996.straw.core.filter.TokenFilter")]),e("br"),s._v("\n拦截器"),e("code",[s._v("TokenFilter")]),s._v("实现"),e("code",[s._v("HandlerInterceptor")]),s._v("，在每次请求进来时进行拦截,在调用controller之前都会调用"),e("code",[s._v("perHandle")]),s._v(",所以在"),e("code",[s._v("perHandler")]),s._v("内获取方法名的注解，判断是否有ignoreToken的注解，然后进行jwt的校验。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(' @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        HandlerMethod handlerMethod = (HandlerMethod) handler;\n        IgnoreToken ignoreToken = handlerMethod.getBeanType().getAnnotation(IgnoreToken.class);\n        log.info("enter preHandle {}",request.getRequestURL());\n        if (ignoreToken == null) {\n            ignoreToken = handlerMethod.getMethodAnnotation(IgnoreToken.class);\n        }\n        if (ignoreToken != null) {\n            log.info("ignoreToken not null");\n            return true;\n        }\n        log.info("ignoreToken  null");\n        String token = request.getHeader("Authorization");\n        if(token != null){\n            log.info("token is {}",token);\n            if ("admin".equals(token.substring(7))) {\n                return true;\n            }\n            Claims claims = JwtHelper.parseJWT(token.substring(7), Audience.BASE64SECRET);\n            if(claims != null){\n                log.info("claims is {} {}",claims.toString(),claims.getSubject());\n                return true;\n            }else{\n                log.info("claims is null");\n                throw new GlobalException(ResultCode.ERROR_AUTH);\n            }\n        }\n        return false;\n    }\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h3",{attrs:{id:"_4-实现web拦截器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-实现web拦截器","aria-hidden":"true"}},[s._v("#")]),s._v(" 4.实现web拦截器")]),s._v(" "),e("p",[s._v("代码"),e("code",[s._v("com.w77996.straw.config.WebMvcAdapterConfig")]),s._v("\n不拦截"),e("code",[s._v("/druid/*")]),s._v("的接口")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('/**\n * @description: web拦截器\n * @author: w77996\n **/\n@Component\npublic class WebMvcAdapterConfig extends WebMvcConfigurationSupport {\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(new TokenFilter()).excludePathPatterns("/druid/*");\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h2",{attrs:{id:"druid监控配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#druid监控配置","aria-hidden":"true"}},[s._v("#")]),s._v(" Druid监控配置")]),s._v(" "),e("p",[s._v("代码"),e("code",[s._v("com.w77996.straw.config.DruidConfig")]),e("br"),s._v("\n项目运行后访问"),e("code",[s._v("http://ip:port/druid")]),s._v(",输入账号"),e("code",[s._v("admin")]),s._v("密码"),e("code",[s._v("amdin")]),s._v("即可访问")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Configuration\npublic class DruidConfig {\n\n    @Bean\n    @ConfigurationProperties("spring.datasource")\n    public DataSource druidDataSource() {\n        DruidDataSource dataSource = new DruidDataSource();\n        return dataSource;\n    }\n\n    @Bean\n    public ServletRegistrationBean druidStatViewServlet() {\n        ServletRegistrationBean registrationBean = new ServletRegistrationBean(new StatViewServlet(), "/druid/*");\n        // IP白名单 (没有配置或者为空，则允许所有访问)e\n        registrationBean.addInitParameter("allow", "");\n        // IP黑名单 (存在共同时，deny优先于allow)\n        registrationBean.addInitParameter("deny", "");\n        registrationBean.addInitParameter("loginUsername", "admin");\n        registrationBean.addInitParameter("loginPassword", "admin");\n        registrationBean.addInitParameter("resetEnable", "false");\n        return registrationBean;\n    }\n\n    @Bean\n    public FilterRegistrationBean druidWebStatViewFilter() {\n        FilterRegistrationBean registrationBean = new FilterRegistrationBean(new WebStatFilter());\n        registrationBean.addInitParameter("urlPatterns", "/*");\n        registrationBean.addInitParameter("exclusions", "*.js,*.gif,*.jpg,*.bmp,*.png,*.css,*.ico,/druid/*");\n        return registrationBean;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h2",{attrs:{id:"全局异常拦截"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全局异常拦截","aria-hidden":"true"}},[s._v("#")]),s._v(" 全局异常拦截")]),s._v(" "),e("p",[s._v("全局异常拦截主要是依靠"),e("code",[s._v("@RestControllerAdvice")]),s._v("注解，在方法上使用"),e("code",[s._v("@ExceptionHandler(value = Exception.class)")]),s._v("代表拦截所有Exception,然后进行对应的操作")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@RestControllerAdvice\npublic class GlobalExceptionHandler {\n\n    /**\n     * 全局错误拦截\n     *\n     * @param e\n     * @return\n     */\n    @ExceptionHandler(value = Exception.class)\n    private Result<Object> exceptionHandler(Exception e) {\n        if (e instanceof GlobalException) {\n            GlobalException ex = (GlobalException) e;\n            return Result.error(ex.getCode());\n        }\n        return Result.error(ResultCode.ERROR.getCode(),e.getMessage());\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h2",{attrs:{id:"微信登录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#微信登录","aria-hidden":"true"}},[s._v("#")]),s._v(" 微信登录")]),s._v(" "),e("p",[s._v("需要在微信公共平台获取对应的appId,appSec，小程序获取到code之后发送给后台，后台获取code向微信发送http请求，使用的是restTemplate,但是需要注意编码，微信编码返回是ISO-8859-1；调用成功后可以拿到用户的openId,再去数据库中获取对应的用户信息，进行登陆更新及用户创建的逻辑处理")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@RestController\n@RequestMapping("/wx")\n@Slf4j\npublic class WxController {\n\n    @Autowired\n    private IUserService iUserService;\n\n    @Value("${wx.appId}")\n    private String wxAppId;\n\n    @Value("${wx.appSec}")\n    private String wxAppSec;\n\n    /**\n     * 通过code获取openId\n     *\n     * @param wxLoginDto\n     * @return\n     */\n    @IgnoreToken\n    @PostMapping("/code")\n    public Result getUserInfoByCode(@RequestBody WxLoginDto wxLoginDto) {\n        log.info("enter getUserInfoByCode");\n        //微信授权获取openId\n        String reqUrl = "https://api.weixin.qq.com/sns/jscode2session?appid=" + wxAppId + "&secret=" + wxAppSec + "&js_code=" + wxLoginDto.getCode() + "&grant_type=authorization_code";\n        JSONObject wxAuthObject = RestHttpClient.client(reqUrl, HttpMethod.GET, null);\n        log.info("wxAuthObject {}", wxAuthObject.toJSONString());\n        WxTokenDto wxTokenDto = JSONObject.parseObject(wxAuthObject.toJSONString(), WxTokenDto.class);\n        log.info("wxTokenDto {}", wxTokenDto.toString());\n        Map<String, Object> tokenMapper = Maps.newHashMapWithExpectedSize(2);\n        //生成新用户\n        UserEntity userEntity = iUserService.getUserByOpenId(wxTokenDto.getOpenid());\n        if (!ObjectUtils.allNotNull(userEntity)) {\n            WxUserInfoDto wxUserInfoDto = new WxUserInfoDto();\n            wxUserInfoDto.setNickname(wxLoginDto.getNickName());\n            wxUserInfoDto.setUserLogo(wxLoginDto.getUserLogo());\n            wxUserInfoDto.setSex(wxLoginDto.getSex());\n            wxUserInfoDto.setLastLogin(new Date());\n            wxUserInfoDto.setOpenId(wxTokenDto.getOpenid());\n            wxUserInfoDto.setLocation(StringUtils.join(new String[]{wxLoginDto.getCountry(), wxLoginDto.getProvince(), wxLoginDto.getCity()}, "-"));\n            iUserService.createNewUser(wxUserInfoDto);\n            log.info("create new user {}", wxUserInfoDto);\n        }\n        tokenMapper.put("token", JwtHelper.createJWT(userEntity.getId() + ""));\n        return Result.success(tokenMapper);\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br")])]),e("h2",{attrs:{id:"spring-boot-maven多环境打包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#spring-boot-maven多环境打包","aria-hidden":"true"}},[s._v("#")]),s._v(" spring boot + maven多环境打包")]),s._v(" "),e("h3",{attrs:{id:"_1-resouce下的yml文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-resouce下的yml文件","aria-hidden":"true"}},[s._v("#")]),s._v(" 1.resouce下的yml文件")]),s._v(" "),e("p",[s._v("项目环境分为"),e("code",[s._v("dev")]),s._v("和"),e("code",[s._v("prod")]),s._v("两种，"),e("code",[s._v("resource")]),s._v("文件下默认加载"),e("code",[s._v("application.yml")]),s._v("。")]),s._v(" "),e("ul",[e("li",[s._v("dev环境：application-dev.yml")]),s._v(" "),e("li",[s._v("prod环境：application-prod.yml\n在"),e("code",[s._v("application.yml")]),s._v("中")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n    profiles:\n      active: @spring.profiles.active@\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("code",[s._v("@spring.profiles.active@")]),s._v("对应的为pom.xml文件中profiles下的"),e("code",[s._v("spring.profiles.active")]),s._v("属性")]),s._v(" "),e("h3",{attrs:{id:"_2-pom-xml配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-pom-xml配置","aria-hidden":"true"}},[s._v("#")]),s._v(" 2.pom.xml配置")]),s._v(" "),e("p",[s._v("默认情况下使用"),e("code",[s._v("dev")]),s._v("环境下的配置信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    <profiles>\n        <profile>\n            <id>dev</id>\n            <activation>\n                <activeByDefault>true</activeByDefault>\n            </activation>\n            <properties>\n                \x3c!-- default Spring profiles --\x3e\n                <spring.profiles.active>dev</spring.profiles.active>\n            </properties>\n        </profile>\n        <profile>\n            <id>prod</id>\n            <properties>\n                \x3c!-- default Spring profiles --\x3e\n                <spring.profiles.active>prod</spring.profiles.active>\n            </properties>\n        </profile>\n    </profiles>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"_3-不同环境打包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-不同环境打包","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.不同环境打包")]),s._v(" "),e("ul",[e("li",[s._v("打包"),e("code",[s._v("prod")]),s._v("环境：执行"),e("code",[s._v("mvn package -Pprod -DskipTests")])]),s._v(" "),e("li",[s._v("打包"),e("code",[s._v("dev")]),s._v("环境：执行"),e("code",[s._v("mvn package -Pdev -DskipTests")])])]),s._v(" "),e("h3",{attrs:{id:"_4-项目打包命名"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-项目打包命名","aria-hidden":"true"}},[s._v("#")]),s._v(" 4.项目打包命名")]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("properties")]),s._v("属性中添加时间格式，然后再"),e("code",[s._v("build")]),s._v("中添加"),e("code",[s._v("fileName")]),s._v("格式化文件名。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    <artifactId>hi-straw</artifactId>\n    <version>1.0.0</version>\n    <properties>\n        ...\n        <maven.build.timestamp.format>yyyy-MM-ddHHmm</maven.build.timestamp.format>\n    </properties>\n    <build>\n        ...\n        <finalName>\n            ${project.artifactId}-${project.version}-${spring.profiles.active}_${maven.build.timestamp}\n        </finalName>\n    </build>\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("打包完成后生成的jar："),e("code",[s._v("hi-straw-1.0.0-prod_2019-04-091533.jar")])]),s._v(" "),e("h2",{attrs:{id:"shell脚本编写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#shell脚本编写","aria-hidden":"true"}},[s._v("#")]),s._v(" shell脚本编写")]),s._v(" "),e("p",[s._v("登陆服务器，clone项目至"),e("code",[s._v("/root/repo_git/")]),s._v("目录下,执行进入"),e("code",[s._v("script")]),s._v("目录下，执行"),e("code",[s._v("./build.sh")]),s._v("，需要将"),e("code",[s._v("RELEASE_HOST")]),s._v("换成你自己的服务器地址，方便做保存备份")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#!/bin/sh\nset -e\n#打包的服务器地址\nRELEASE_HOST="你自己的服务器地址"\n#打包的环境\nRELEASE_ENV=prod\n#项目目录\nBASE_DIR=/root/repo_git/Histraw\n#进入项目目录\ncd ${BASE_DIR}\n#执行git拉去最新的代码\necho "pulling changes..."\ngit pull origin master\necho "pulling changes... finish"\necho "building..."\n#执行mvn命令打包\nmvn clean\nmvn package -P${RELEASE_ENV} -DskipTests docker:build\necho "building...finish"\necho "env =${RELEASE_ENV}"\n#for HOST in ${RELEASE_HOST}; do\n#进行拷贝及备份\nRELEASE_TARGET=root@${RELEASE_HOST}:~/release/\necho "copying to $RELEASE_TARGET..."\nscp ${BASE_DIR}/target/*.jar ${RELEASE_TARGET}\necho "copying to $RELEASE_TARGET...done"\n#done\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSz6uFHLz8ibYV6icFGjER0eOuaM3jo5mYlG8prMgnhT7LHGRy1NIK2AzZA/0?wx_fmt=png",alt:"执行build.sh"}}),s._v("\n执行"),e("code",[s._v("docker images")]),s._v("查看刚刚打包好的docker镜像\n"),e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSzvuwuH3u1VAiaeFjicibNjTkNrHiatSsqQZ7YLErBVHvzd8icyae68XyxZEg/0?wx_fmt=png",alt:"docker镜像"}})]),s._v(" "),e("h2",{attrs:{id:"maven-docker-打包部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#maven-docker-打包部署","aria-hidden":"true"}},[s._v("#")]),s._v(" maven + docker 打包部署")]),s._v(" "),e("h3",{attrs:{id:"_1-docker环境安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-docker环境安装","aria-hidden":"true"}},[s._v("#")]),s._v(" 1.docker环境安装")]),s._v(" "),e("p",[s._v("卸载老旧的版本（若未安装过可省略此步）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("sudo apt-get remove docker docker-engine docker.io\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("安装最新的docker：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("curl -fsSL get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("确认Docker成功安装：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("docker run hello-world\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"_2-项目编译打包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-项目编译打包","aria-hidden":"true"}},[s._v("#")]),s._v(" 2.项目编译打包")]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("src/main/docker")]),s._v("下建立"),e("code",[s._v("dockerFile")]),s._v("文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('FROM openjdk:8-jdk-alpine\nVOLUME /tmp\nADD *.jar app.jar\nENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"]\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("pom.xml配置docker打包，配合shell脚本在linux实现maven自动打包docker")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" \x3c!-- Docker maven plugin --\x3e\n    <plugin>\n        <groupId>com.spotify</groupId>\n        <artifactId>docker-maven-plugin</artifactId>\n        <version>1.0.0</version>\n        <configuration>\n            <imageName>${project.artifactId}</imageName>\n            <dockerDirectory>src/main/docker</dockerDirectory>\n            <resources>\n                <resource>\n                    <targetPath>/</targetPath>\n                    <directory>${project.build.directory}</directory>\n                    <include>${project.build.finalName}.jar</include>\n                </resource>\n            </resources>\n        </configuration>\n    </plugin>\n\x3c!-- Docker maven plugin --\x3e\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("执行"),e("code",[s._v("docker images")]),s._v("查看刚刚打包的docker镜像")]),s._v(" "),e("p",[s._v("执行"),e("code",[s._v("docker run --name hi-straw -p 8989:8989 -t hi-straw")]),s._v("启动镜像")]),s._v(" "),e("p",[s._v("执行"),e("code",[s._v("dockers ps")]),s._v("查看已启动docker镜像\n"),e("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/K9o04n1smLyCcJ5MDvS4o51739H8mJSzTpUZUSb5749UHFTp8ibA7PqyTy7be26Zpl4bth6tiaDyLklkOLWpiazmg/0?wx_fmt=png",alt:"已启动"}})]),s._v(" "),e("h2",{attrs:{id:"nginx配置https"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置https","aria-hidden":"true"}},[s._v("#")]),s._v(" nginx配置https")]),s._v(" "),e("h3",{attrs:{id:"_1-安装nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装nginx","aria-hidden":"true"}},[s._v("#")]),s._v(" 1.安装nginx")]),s._v(" "),e("p",[s._v("登陆到服务器，执行")]),s._v(" "),e("pre",[e("code",[s._v("$ apt-get update // 更新软件\n$ apt-get install nginx // 安装nginx\n")])]),s._v(" "),e("h3",{attrs:{id:"_2-获取证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-获取证书","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. 获取证书")]),s._v(" "),e("p",[s._v("可以去"),e("a",{attrs:{href:"https://www.aliyun.com/product/cas?spm=5176.224200.1280361.173.78256ed67r0qWd",target:"_blank",rel:"noopener noreferrer"}},[s._v("阿里云获取免费证书"),e("OutboundLink")],1),e("br"),s._v("\n将生成的证书放入"),e("code",[s._v("/etc/nginx/sites-enabled/cert/")]),s._v("(具体看你将nginx安装在哪个目录下)")]),s._v(" "),e("h3",{attrs:{id:"_3-配置nginx文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置nginx文件","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. 配置nginx文件")]),s._v(" "),e("p",[s._v("新建一个https.conf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n    listen 443;\n    server_name 你自己的域名;\n    ssl on;\n    ssl_certificate  cert/你自己的证书.pem;\n    ssl_certificate_key cert/你自己的证书.key;\n    ssl_session_timeout 5m;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n    location / {\n        #项目部署的ip和端口\n    \tproxy_pass http://localhost:port;\n\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("配置完成后，检查一下nginx配置文件是否可用")]),s._v(" "),e("pre",[e("code",[s._v("nginx -t //检查nginx配置文件\n")])]),s._v(" "),e("p",[s._v("配置正确后，重新加载配置文件使配置生效")]),s._v(" "),e("pre",[e("code",[s._v("nginx -s reload //使配置生效\n")])]),s._v(" "),e("p",[s._v("如需重启nginx，用以下命令：")]),s._v(" "),e("pre",[e("code",[s._v("service nginx stop //停止\nservice nginx start //启动\nservice nginx restart //重启\n")])]),s._v(" "),e("h1",{attrs:{id:"部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署","aria-hidden":"true"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),e("p",[s._v("修改"),e("code",[s._v("resource")]),s._v("下的"),e("code",[s._v("application-dev.yml")]),s._v("和"),e("code",[s._v("application-prod.yml")]),s._v("中你自己申请的微信息及七牛云信息修改，修改数据库地址，用户名和密码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#七牛\nqiNiu:\n  accessKey: 你申请的七牛云key\n  secretKey: 你申请的七牛云sec\n  bucket: 你申请的七牛云bucket\n  domain: 你申请的七牛云domain\n#微信\nwx:\n  appId: 你申请的微信id\n  appSec: 你申请的微信sec\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("spring:\n  datasource:\n    name: graduate\n    driver-class-name: com.mysql.jdbc.Driver\n    url: 数据库地址\n    username: 数据库用户名\n    password: 数据库密码\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("修改"),e("code",[s._v("script")]),s._v("目录下"),e("code",[s._v("build.sh")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('RELEASE_HOST="你自己的服务器地址"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])},[],!1,null,null,null);n.default=t.exports}}]);