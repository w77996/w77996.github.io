(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{210:function(e,s,r){"use strict";r.r(s);var a=r(0),n=Object(a.a)({},function(){var e=this,s=e.$createElement,r=e._self._c||s;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"rocketmq安装部署"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#rocketmq安装部署","aria-hidden":"true"}},[e._v("#")]),e._v(" RocketMQ安装部署")]),e._v(" "),r("h2",{attrs:{id:"_1-部署堆内存配置"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-部署堆内存配置","aria-hidden":"true"}},[e._v("#")]),e._v(" 1.部署堆内存配置:")]),e._v(" "),r("pre",[r("code",[e._v('分别对应修改nameserver和broker脚本：runserver.sh和runbroker.sh，默认内存分配是非常大的，可以改小点\n\nJAVA_OPT="${JAVA_OPT} -server -Xms1g -Xmx1g -Xmn512m"\n')])]),e._v(" "),r("h2",{attrs:{id:"_2-启动运行："}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-启动运行：","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.启动运行：")]),e._v(" "),r("pre",[r("code",[e._v("参见quickstart:http://rocketmq.apache.org/docs/quick-start/\n\n其中需要注意的是rocketmq默认情况下不允许自动创建topic，可以在启动broker命令后面加上autoCreateTopicEnable=true，运行自动创建topic，就可以在命令行测试收发消息了\n")])]),e._v(" "),r("h2",{attrs:{id:"_3-集群模式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-集群模式","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.集群模式")]),e._v(" "),r("p",[e._v("目前有以下几种集群模式：")]),e._v(" "),r("h3",{attrs:{id:"_1-多master模式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-多master模式","aria-hidden":"true"}},[e._v("#")]),e._v(" 1.多Master模式")]),e._v(" "),r("pre",[r("code",[e._v("    一个集群无 Slave，全是 Master，例如 2 个 Master 或者 3 个 Master\n\n    优点：配置简单，单个Master 宕机或重启维护对应用无影响，在磁盘配置为RAID10 时，即使机器宕机不可恢复情况下，由与 RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢）。性能最高。多 Master 多 Slave 模式，异步复制\n\n    缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到受到影响\n")])]),e._v(" "),r("h3",{attrs:{id:"_2-多master多slave模式（异步复制）"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-多master多slave模式（异步复制）","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.多Master多Slave模式（异步复制）")]),e._v(" "),r("pre",[r("code",[e._v("    每个 Master 配置一个 Slave，有多对Master-Slave， HA，采用异步复制方式，主备有短暂消息延迟，毫秒级。\n\n    优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，因为Master 宕机后，消费者仍然可以从 Slave消费，此过程对应用透明。不需要人工干预。性能同多 Master 模式几乎一样。\n\n    缺点： Master 宕机，磁盘损坏情况，会丢失少量消息。\n")])]),e._v(" "),r("h3",{attrs:{id:"_3-多master多slave模式（同步双写）"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-多master多slave模式（同步双写）","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.多Master多Slave模式（同步双写）")]),e._v(" "),r("pre",[r("code",[e._v("    每个 Master 配置一个 Slave，有多对Master-Slave， HA采用同步双写方式，主备都写成功，向应用返回成功。\n\n    优点：数据与服务都无单点， Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高\n\n    缺点：性能比异步复制模式略低，大约低 10%左右，发送单个消息的 RT会略高。目前主宕机后，备机不能自动切换为主机，后续会支持自动切换功能\n")])]),e._v(" "),r("h3",{attrs:{id:"_4-双主双从异步复制集群搭建（厦门环境202-203两主对应232-233两从4台机器部署）"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-双主双从异步复制集群搭建（厦门环境202-203两主对应232-233两从4台机器部署）","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.双主双从异步复制集群搭建（厦门环境202,203两主对应232,233两从4台机器部署）")]),e._v(" "),r("pre",[r("code",[e._v("消息丢失在可接受范围内，几乎可以认为不会丢失消息，性能也高\n\n  在202，203机器启动集群两台nameserver\n")])]),e._v(" "),r("p",[e._v("1.创建namesrv配置文件，设置监听端口：")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("[root@lrxm202 conf]# vi namesrv.properties\nstenPort=9876\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br")])]),r("p",[e._v("2.启动202机器上的nameserver")]),e._v(" "),r("pre",[r("code",[e._v("[root@lrxm202 conf]# cd ../bin/\n[root@lrxm202 bin]# nohup sh mqnamesrv -c ../conf/namesrv.properties  > ./nohup.out 2>&1 &\n")])]),e._v(" "),r("p",[e._v("启动没问题，接下来以相同的方式依次启动其他机器上的namesrv")]),e._v(" "),r("pre",[r("code",[e._v(" 202，203机器分别启动broker主从\n\n 202机器上的master,broker-a主要配置\n")])]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("brokerClusterName=lrts-cluster\n#broker名称\nbrokerName=broker-a\n#brokerId,0表示master,大于0表示slave\nbrokerId=0\n#nameserver地址，两台分别部署在202,203\nnamesrvAddr=192.168.5.202:9876;192.168.5.203:9876\n#默认值，每天凌晨4点删除文件\ndeleteWhen=04\n#默认值，文件保留48h\nfileReservedTime=48\n#Broker 的角色\n#- ASYNC_MASTER 异步复制Master\n#- SYNC_MASTER 同步双写Master\n#- SLAVE\nbrokerRole=SYNC_MASTER\n#刷盘方式\n#- ASYNC_FLUSH 异步刷盘\n#- SYNC_FLUSH 同步刷盘\nflushDiskType=ASYNC_FLUSH\n#检测物理文件磁盘空间\ndiskMaxUsedSpaceRatio=88\n#存储路径\nstorePathRootDir=/data/rocketmq/store\n#commitLog 存储路径\nstorePathCommitLog=/data/rocketmq/store/commitlog\n#消费队列存储路径存储路径\nstorePathConsumeQueue=/data/rocketmq/store/consumequeue\n#消息索引存储路径\nstorePathIndex=/data/rocketmq/store/index\n#checkpoint 文件存储路径\nstoreCheckpoint=/data/rocketmq/store/checkpoint\n#abort 文件存储路径\nabortFile=/data/rocketmq/store/abort\n#限制的消息大小\nmaxMessageSize=65536\n#启动202机器上的broker-a\n[root@lrxm202 bin]# nohup sh mqbroker -c ../conf/2m-2s-sync/broker-a.properties >/dev/null 2>&1 &\nbroker-a启动成功\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br"),r("span",{staticClass:"line-number"},[e._v("8")]),r("br"),r("span",{staticClass:"line-number"},[e._v("9")]),r("br"),r("span",{staticClass:"line-number"},[e._v("10")]),r("br"),r("span",{staticClass:"line-number"},[e._v("11")]),r("br"),r("span",{staticClass:"line-number"},[e._v("12")]),r("br"),r("span",{staticClass:"line-number"},[e._v("13")]),r("br"),r("span",{staticClass:"line-number"},[e._v("14")]),r("br"),r("span",{staticClass:"line-number"},[e._v("15")]),r("br"),r("span",{staticClass:"line-number"},[e._v("16")]),r("br"),r("span",{staticClass:"line-number"},[e._v("17")]),r("br"),r("span",{staticClass:"line-number"},[e._v("18")]),r("br"),r("span",{staticClass:"line-number"},[e._v("19")]),r("br"),r("span",{staticClass:"line-number"},[e._v("20")]),r("br"),r("span",{staticClass:"line-number"},[e._v("21")]),r("br"),r("span",{staticClass:"line-number"},[e._v("22")]),r("br"),r("span",{staticClass:"line-number"},[e._v("23")]),r("br"),r("span",{staticClass:"line-number"},[e._v("24")]),r("br"),r("span",{staticClass:"line-number"},[e._v("25")]),r("br"),r("span",{staticClass:"line-number"},[e._v("26")]),r("br"),r("span",{staticClass:"line-number"},[e._v("27")]),r("br"),r("span",{staticClass:"line-number"},[e._v("28")]),r("br"),r("span",{staticClass:"line-number"},[e._v("29")]),r("br"),r("span",{staticClass:"line-number"},[e._v("30")]),r("br"),r("span",{staticClass:"line-number"},[e._v("31")]),r("br"),r("span",{staticClass:"line-number"},[e._v("32")]),r("br"),r("span",{staticClass:"line-number"},[e._v("33")]),r("br"),r("span",{staticClass:"line-number"},[e._v("34")]),r("br"),r("span",{staticClass:"line-number"},[e._v("35")]),r("br"),r("span",{staticClass:"line-number"},[e._v("36")]),r("br"),r("span",{staticClass:"line-number"},[e._v("37")]),r("br"),r("span",{staticClass:"line-number"},[e._v("38")]),r("br"),r("span",{staticClass:"line-number"},[e._v("39")]),r("br")])]),r("p",[e._v("接下来启动203上集群的master broker-b，配置文件202上的master是一致的，只需要改动brokerName即可，可以看到是启动成功的")]),e._v(" "),r("p",[e._v("232机器上broker-a副本的配置：\n作为broker-a的副本，需要改一下2个地方")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("brokerId=1\nbrokerRole=SLAVE\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br")])]),r("p",[e._v("最后依次启动232,233机器上的副本rocketmq")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("nohup sh mqbroker -c ../conf/2m-2s-sync/broker-a-s.properties >/dev/null 2>&1 &\nnohup sh mqbroker -c ../conf/2m-2s-sync/broker-b-s.properties >/dev/null 2>&1 &\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br")])]),r("h1",{attrs:{id:"启动步骤"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#启动步骤","aria-hidden":"true"}},[e._v("#")]),e._v(" 启动步骤")]),e._v(" "),r("p",[e._v("1.修改配置文件：")]),e._v(" "),r("p",[e._v("broker-a.properties")]),e._v(" "),r("p",[e._v("broker-a-s.properties")]),e._v(" "),r("p",[e._v("broker-b.properties")]),e._v(" "),r("p",[e._v("broker-b-s.properties")]),e._v(" "),r("p",[e._v("2.202上启动nameserver1")]),e._v(" "),r("p",[e._v("修改启动参数：vi runserver.sh")]),e._v(" "),r("pre",[r("code",[e._v('JAVA_OPT="${JAVA_OPT} -server -Xms2g -Xmx2g -Xmn512m -XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m"\n启动命令：\n\nnohup sh mqnamesrv -c ../conf/namesrv.properties  > ./nohup.out 2>&1 &\n')])]),e._v(" "),r("p",[e._v("查看启动进程（启动成功）")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("[root@lrxm202 bin]# ps -ef| grep name\nroot     17355 16104  0 15:48 pts/2    00:00:00 sh mqnamesrv -c ../conf/namesrv.properties\nroot     17359 17355  0 15:48 pts/2    00:00:00 sh /usr/local/rocketmq-all-4.4.0/bin/runserver.sh org.apache.rocketmq.namesrv.NamesrvStartup -c ../conf/namesrv.properties\nroot     17361 17359 31 15:48 pts/2    00:00:03 /usr/local/jdk/bin/java -server -Xms1g -Xmx1g -Xmn512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSInitiatingOccupancyFraction=70 -XX:+CMSParallelRemarkEnabled -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+CMSClassUnloadingEnabled -XX:SurvivorRatio=8 -XX:-UseParNewGC -verbose:gc -Xloggc:/dev/shm/rmq_srv_gc.log -XX:+PrintGCDetails -XX:-OmitStackTraceInFastThrow -XX:-UseLargePages -Djava.ext.dirs=/usr/local/jdk/jre/lib/ext:/usr/local/rocketmq-all-4.4.0/bin/../lib -cp .:/usr/local/rocketmq-all-4.4.0/bin/../conf: org.apache.rocketmq.namesrv.NamesrvStartup -c ../conf/namesrv.properties\nroot     17384 16104  0 15:48 pts/2    00:00:00 grep name\n[root@lrxm202 bin]#\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br")])]),r("ol",{attrs:{start:"3"}},[r("li",[e._v("203上以同样方式启动（启动成功）")])]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("[root@lrxm203 bin]# ps -ef| grep name\nroot       955     1  2 Mar08 ?        17:30:00 ./pd-server --name=pd2 --data-dir=data/pd2 --client-urls=http://192.168.5.203:2379 --peer-urls=http://192.168.5.203:2380 --initial-cluster=pd1=http://192.168.5.202:2380,pd2=http://192.168.5.203:2380,pd3=http://192.168.5.204:2380 -L info --log-file=logs/pd.log\nroot     23321 22919  0 15:50 pts/1    00:00:00 sh mqnamesrv -c ../conf/namesrv.properties\nroot     23325 23321  0 15:50 pts/1    00:00:00 sh /usr/local/rocketmq-all-4.4.0/bin/runserver.sh org.apache.rocketmq.namesrv.NamesrvStartup -c ../conf/namesrv.properties\nroot     23327 23325 51 15:50 pts/1    00:00:03 /usr/local/jdk/bin/java -server -Xms1g -Xmx1g -Xmn512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:CMSInitiatingOccupancyFraction=70 -XX:+CMSParallelRemarkEnabled -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+CMSClassUnloadingEnabled -XX:SurvivorRatio=8 -XX:-UseParNewGC -verbose:gc -Xloggc:/dev/shm/rmq_srv_gc.log -XX:+PrintGCDetails -XX:-OmitStackTraceInFastThrow -XX:-UseLargePages -Djava.ext.dirs=/usr/local/jdk/jre/lib/ext:/usr/local/rocketmq-all-4.4.0/bin/../lib -cp .:/usr/local/rocketmq-all-4.4.0/bin/../conf: org.apache.rocketmq.namesrv.NamesrvStartup -c ../conf/namesrv.properties\nroot     23348 22919  0 15:50 pts/1    00:00:00 grep name\n[root@lrxm203 bin]#\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br")])]),r("p",[e._v("4.202上启动master-a")]),e._v(" "),r("p",[e._v("修改启动参数")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('[root@lrxm202 bin]# vi runbroker.sh\n#===========================================================================================\n# JVM Configuration\n#===========================================================================================\nJAVA_OPT="${JAVA_OPT} -server -Xms1g -Xmx1g -Xmn512m"\nJAVA_OPT="${JAVA_OPT} -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0"\nJAVA_OPT="${JAVA_OPT} -verbose:gc -Xloggc:/dev/shm/mq_gc_%p.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy"\n')])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br")])]),r("p",[e._v("启动broker-a")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("nohup sh mqbroker -c ../conf/2m-2s-sync/broker-a.properties >/dev/null 2>&1 &\n\n203启动broker-a-s\n\nnohup sh mqbroker -c ../conf/2m-2s-sync/broker-a-s.properties >/dev/null 2>&1 &\n\n232启动broker-b\n\nnohup sh mqbroker -c ../conf/2m-2s-sync/broker-b.properties >/dev/null 2>&1 &\n\n233启动broker-b-s\n\nnohup sh mqbroker -c ../conf/2m-2s-sync/broker-b-s.properties >/dev/null 2>&1 &\n\n")])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br"),r("span",{staticClass:"line-number"},[e._v("8")]),r("br"),r("span",{staticClass:"line-number"},[e._v("9")]),r("br"),r("span",{staticClass:"line-number"},[e._v("10")]),r("br"),r("span",{staticClass:"line-number"},[e._v("11")]),r("br"),r("span",{staticClass:"line-number"},[e._v("12")]),r("br"),r("span",{staticClass:"line-number"},[e._v("13")]),r("br"),r("span",{staticClass:"line-number"},[e._v("14")]),r("br")])]),r("p",[e._v("关闭namesrv服务：sh bin/mqshutdown namesrv")]),e._v(" "),r("p",[e._v("关闭broker服务 ：sh bin/mqshutdown broker")]),e._v(" "),r("h1",{attrs:{id:"启动和关闭"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#启动和关闭","aria-hidden":"true"}},[e._v("#")]),e._v(" 启动和关闭")]),e._v(" "),r("pre",[r("code",[e._v("nohup sh mqnamesrv -c ../conf/namesrv.properties  > ./nohup.out 2>&1 &\nnohup sh mqbroker -c ../conf/2m-2s-sync/broker-a-s.properties >/dev/null 2>&1 &\n\nsh bin/mqshutdown broker\nsh bin/mqshutdown namesrv")])])])},[],!1,null,null,null);s.default=n.exports}}]);